#!/usr/bin/env node
// Generated by CoffeeScript 1.3.3
var Bundle, Line, bundle, bundles, crypto, data, domain, fs, http, load, loadFiles, mapping, mime, path, soma, sources, url, _i, _len, _ref,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

crypto = require('crypto');

domain = require('domain');

http = require('http');

fs = require('fs');

path = require('path');

mime = require('../lib/node/lib/mime');

soma = require('soma');

Line = require('line').Line;

loadFiles = function(source, tree, files, callback) {
  var abs, basename, encoding, url, watcher, _ref;
  if (tree == null) {
    tree = {};
  }
  if (files == null) {
    files = {};
  }
  basename = path.basename(source);
  if (fs.statSync(source).isDirectory()) {
    watcher = fs.watch(source, function() {
      var l;
      if (!path.existsSync(source)) {
        console.log('Directory went missing: ', source);
        delete tree[basename];
        watcher.close();
        return;
      }
      tree[basename] = {};
      return l = new Line({
        error: function(err) {
          throw err;
        }
      }, function() {
        return fs.readdir(source, line.wait());
      }, function(names) {
        var name, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = names.length; _i < _len; _i++) {
          name = names[_i];
          if (name[0] === '.') {
            continue;
          }
          _results.push(loadFiles("" + source + "/" + name, tree[basename], files = {}, line.wait()));
        }
        return _results;
      }, function() {
        return callback(tree);
      });
    });
    watcher.emit('change');
  } else {
    abs = "" + (process.cwd()) + "/" + source;
    url = "/" + source;
    if ((_ref = mime.lookup(source).slice(0, 4)) === 'text') {
      encoding = 'utf8';
    }
    fs.readFile(source, encoding, function(err, data) {
      if (err) {
        return callback.apply(this, arguments);
      }
      tree[basename] = url;
      files[url] = data;
      callback(null, tree);
    });
  }
};

load = function(source, exec, serve) {
  var abs, m, name, names, stats, url, urls, watcher, _i, _len;
  stats = fs.statSync(source);
  if (stats.isDirectory()) {
    urls = [];
    names = fs.readdirSync(source);
    for (_i = 0, _len = names.length; _i < _len; _i++) {
      name = names[_i];
      if (name[0] === '.') {
        continue;
      }
      urls = urls.concat(load("" + source + "/" + name, exec, serve));
    }
    return urls;
  } else {
    abs = "" + (process.cwd()) + "/" + source;
    url = "/" + source;
    if (__indexOf.call(soma.files, url) >= 0) {
      return;
    }
    watcher = fs.watch(source, function() {
      var encoding, _ref;
      if (!path.existsSync(source)) {
        console.log('Module went missing: ', source);
        watcher.close();
        return;
      }
      try {
        if (serve) {
          if ((_ref = mime.lookup(source).slice(0, 4)) === 'text') {
            encoding = 'utf8';
          }
          return soma.files[url] = fs.readFileSync(source, encoding);
        }
      } catch (e) {
        console.log('Failed to reload module: ', source);
        return console.log(e.stack);
      }
    });
    watcher.emit('change');
    if (exec && source.slice(-3) === '.js') {
      soma._src = url;
      m = require(abs);
      soma._src = null;
    }
    return [url];
  }
};

Bundle = (function() {

  function Bundle(sources) {
    this.files = {};
    this.hash = null;
    this.collect(sources, soma.tree);
  }

  Bundle.prototype.hash = function() {
    var data, sha, url, _ref;
    sha = crypto.createHash('sha1');
    _ref = this.files;
    for (url in _ref) {
      data = _ref[url];
      sha.update(url);
      sha.update(data);
    }
    this.hash = sha.digest('hex');
  };

  Bundle.prototype.collect = function(sources, tree) {
    var branch, part, parts, source, _i, _j, _len, _len1;
    for (_i = 0, _len = sources.length; _i < _len; _i++) {
      source = sources[_i];
      parts = source.split('/');
      branch = tree;
      for (_j = 0, _len1 = parts.length; _j < _len1; _j++) {
        part = parts[_j];
        if (!(part in branch)) {
          branch = null;
          break;
        }
        branch = branch[part];
      }
      if (typeof branch === 'object') {
        bundle(branch, branch, files);
      } else {
        this.files[branch] = soma.files[branch];
      }
    }
  };

  Bundle.prototype.write = function(dir, callback) {
    var data;
    data = "soma.bundles['" + this.hash + "'] = " + (JSON.stringify(this.files)) + ";";
    fs.writeFile("" + dir + "/" + this.hash + ".js", data, 'utf8', callback);
  };

  return Bundle;

})();

soma.load = function() {
  var _base, _base1;
  soma.config = require('./package.json');
  (_base = soma.config).chunks || (_base.chunks = 'chunks');
  (_base1 = soma.config).templates || (_base1.templates = 'templates');
  soma.files = {};
  soma.tree = {};
  soma.bundles = {};
  loadFiles(soma.config.chunks, soma.tree, soma.files);
  loadFiles(soma.config.templates, soma.tree, soma.files);
  loadFiles('bundles', soma.tree, soma.files);
  return soma.bundled = require('./bundles');
};

soma.init = function() {
  var scripts, serverDomain, source, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3;
  _ref = soma.config.shared;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    source = _ref[_i];
    load(path.normalize(source), true, true);
  }
  _ref1 = soma.config.server;
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    source = _ref1[_j];
    load(path.normalize(source), true, false);
  }
  _ref2 = soma.config.client;
  for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
    source = _ref2[_k];
    load(path.normalize(source), false, true);
  }
  scripts = [];
  _ref3 = soma.config.init;
  for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
    source = _ref3[_l];
    scripts = scripts.concat(load(path.normalize(source), false, true));
  }
  serverDomain = domain.create();
  return serverDomain.run(function() {
    var port, server;
    server = http.createServer(function(request, response) {
      var requestDomain;
      requestDomain = domain.create();
      requestDomain.add(request);
      requestDomain.add(response);
      requestDomain.on('error', function(err) {
        console.error('Error', request.url, (err != null ? err.stack : void 0) || err);
        try {
          response.statusCode = 500;
          response.end('Error occurred, sorry.');
          return response.on('close', function() {
            return requestDomain.dispose();
          });
        } catch (err) {
          console.error('Error sending 500', request.url, err);
          return requestDomain.dispose();
        }
      });
      return requestDomain.run(function() {
        var content, contentLength, contentType, context;
        if (request.url in soma.files) {
          contentType = mime.lookup(request.url);
          content = soma.files[request.url];
          if (content instanceof Buffer) {
            contentLength = content.length;
          } else {
            contentLength = Buffer.byteLength(content);
          }
          response.setHeader('Content-Type', contentType);
          response.setHeader('Content-Length', contentLength);
          return response.end(content);
        } else {
          context = new soma.ClientContext(request, response, scripts);
          return context.begin();
        }
      });
    });
    port = process.env.PORT || soma.config.port || 8000;
    server.listen(port);
    return console.log("Soma listening on port " + port + "...");
  });
};

if (process.argv[2] === 'bundle') {
  soma.load();
  bundles = {};
  mapping = {};
  _ref = soma.config.bundles;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    sources = _ref[_i];
    bundle = new Bundle(sources);
    bundle.write('bundles', function(err) {
      if (err) {
        throw err;
      }
    });
    bundles[bundle.hash] = bundle;
    for (url in bundles.files) {
      mapping[url] = bundle.hash;
    }
  }
  data = "module.exports = " + (JSON.stringify(mapping)) + ";";
  fs.writeFile("" + dir + "/index.js", data, 'utf8', function(err) {
    if (err) {
      throw err;
    }
  });
} else {
  soma.load();
  soma.init();
}
